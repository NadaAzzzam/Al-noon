@if (showWidget()) {
<div class="chatbot-widget" [class.open]="open()" [class.ready]="widgetReady()">

  <!-- Greeting Toast -->
  @if (showGreetingToast() && !open()) {
  <div class="greeting-toast" (click)="toggle()">
    <button type="button" class="toast-close" (click)="dismissToast(); $event.stopPropagation()" aria-label="Dismiss">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M1 1L13 13M13 1L1 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
      </svg>
    </button>
    <div class="toast-content">
      <div class="toast-avatar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="currentColor"
            opacity="0.15" />
          <path d="M12 4a4 4 0 100 8 4 4 0 000-8zm0 10c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z" fill="currentColor"
            opacity="0.7" />
        </svg>
      </div>
      <div class="toast-text">
        <span class="toast-greeting">{{ 'chatbot.greetingTitle' | translate }}</span>
        <span class="toast-desc">{{ 'chatbot.greetingDesc' | translate }}</span>
      </div>
    </div>
    <div class="toast-cta">{{ 'chatbot.startChat' | translate }}</div>
  </div>
  }

  <!-- Toggle Button -->
  <button type="button" class="chatbot-toggle" (click)="toggle()" [attr.aria-label]="'chatbot.title' | translate">
    <span class="toggle-icon" [class.is-open]="open()">
      @if (open()) {
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M6 6L18 18M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
      </svg>
      } @else {
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
        <path
          d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H8L12 22L16 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"
          fill="currentColor" opacity="0.85" />
        <circle cx="8" cy="10" r="1.2" fill="white" />
        <circle cx="12" cy="10" r="1.2" fill="white" />
        <circle cx="16" cy="10" r="1.2" fill="white" />
      </svg>
      }
    </span>
    <!-- Sparkle decorations -->
    <span class="sparkle sparkle-1"></span>
    <span class="sparkle sparkle-2"></span>
    <span class="sparkle sparkle-3"></span>
    <!-- Pulse ring -->
    @if (!open() && !toastDismissed()) {
    <span class="pulse-ring"></span>
    }
  </button>

  <!-- Chat Panel -->
  @if (open()) {
  <div class="chatbot-panel">
    <div class="panel-header">
      <div class="panel-header-info">
        <div class="panel-avatar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path
              d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H8L12 22L16 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"
              fill="currentColor" />
          </svg>
        </div>
        <div>
          <span class="panel-title">{{ 'chatbot.panelTitle' | translate }}</span>
          <span class="panel-status">{{ 'chatbot.online' | translate }}</span>
        </div>
      </div>
    </div>

    <div class="chatbot-messages">
      @for (msg of messages(); track $index) {
      <div class="message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'">
        @if (msg.role === 'assistant') {
        <div class="msg-avatar">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path
              d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H8L12 22L16 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"
              fill="currentColor" />
          </svg>
        </div>
        }
        <div class="msg-body">
          <div class="message-text" [innerHTML]="msg.text | sanitizeHtml"></div>
          @if (msg.productCards?.length) {
          <div class=" product-cards">
            @for (card of msg.productCards; track card.id) {
            <a [routerLink]="pathService.path('product', card.id)" class="product-card-link">
              @if (card.image) {
              <img [src]="api.imageUrl(card.image)" [alt]="getCardName(card)" />
              }
              <span>{{ getCardName(card) }}</span>
            </a>
            }
          </div>
          }
        </div>
      </div>
      }
      @if (loading()) {
      <div class="message assistant">
        <div class="msg-avatar">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path
              d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H8L12 22L16 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"
              fill="currentColor" />
          </svg>
        </div>
        <div class="msg-body">
          <p class="message-text typing-indicator">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </p>
        </div>
      </div>
      }
    </div>

    @if (error()) {
    <p class="chatbot-error">{{ error() }}</p>
    }

    @if (settings()?.suggestedQuestions?.length && messages().length <= 1) { <div class="suggested">
      @for (q of settings()!.suggestedQuestions; track $index) {
      <button type="button" class="suggested-btn" (click)="sendSuggested(getLocalized(q))">
        {{ getLocalized(q) }}
      </button>
      }
  </div>
  }

  <form class="chatbot-input" (ngSubmit)="send()">
    <input type="text" [value]="input()" (input)="input.set($any($event.target).value)"
      [placeholder]="'chatbot.placeholder' | translate" [disabled]="loading()" />
    <button type="submit" class="send-btn" [disabled]="loading() || !input().trim()"
      [attr.aria-label]="'chatbot.send' | translate">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor" />
      </svg>
    </button>
  </form>
</div>
}
</div>
}