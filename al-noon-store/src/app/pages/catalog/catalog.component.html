<div class="catalog container">
  <!-- ── Top filter bar ── -->
  <div class="catalog-toolbar">
    <button type="button" class="toolbar-filter-btn" (click)="toggleFilters()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" y1="21" x2="4" y2="14" />
        <line x1="4" y1="10" x2="4" y2="3" />
        <line x1="12" y1="21" x2="12" y2="12" />
        <line x1="12" y1="8" x2="12" y2="3" />
        <line x1="20" y1="21" x2="20" y2="16" />
        <line x1="20" y1="12" x2="20" y2="3" />
        <line x1="1" y1="14" x2="7" y2="14" />
        <line x1="9" y1="8" x2="15" y2="8" />
        <line x1="17" y1="16" x2="23" y2="16" />
      </svg>
      {{ 'catalog.filters' | translate }}
      @if (activeFilterCount() > 0) {
      <span class="toolbar-badge">{{ activeFilterCount() }}</span>
      }
    </button>

    @if (!loading()) {
    <span class="toolbar-count">{{ total() }} {{ 'catalog.results' | translate }}</span>
    }

    <div class="toolbar-sort">
      <select [ngModel]="sort()" (ngModelChange)="sort.set($event); applyFilters()">
        @for (opt of sortOptionsForSelect(); track opt.value) {
        <option [value]="opt.value">{{ getLocalized({ en: opt.labelEn, ar: opt.labelAr }) }}</option>
        }
      </select>
      <svg class="sort-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9" />
      </svg>
    </div>
  </div>

  <!-- Active filter chips -->
  @if (activeFilterCount() > 0) {
  <div class="active-filters">
    @if (search()) {
    <button type="button" class="filter-chip" (click)="removeFilter('search')">
      {{ 'catalog.search' | translate }}: {{ search() }} <span class="chip-close">&times;</span>
    </button>
    }
    @if (categoryId()) {
    <button type="button" class="filter-chip" (click)="removeFilter('category')">
      {{ categoryDisplayName() }} <span class="chip-close">&times;</span>
    </button>
    }
    @if (availability() !== 'all') {
    <button type="button" class="filter-chip" (click)="removeFilter('availability')">
      @if (availability() === 'inStock') {
      {{ 'catalog.inStock' | translate }}
      } @else if (availability() === 'outOfStock') {
      {{ 'catalog.outOfStock' | translate }}
      } @else {
      {{ availability() }}
      }
      <span class="chip-close">&times;</span>
    </button>
    }
    @if (minPrice() != null) {
    <button type="button" class="filter-chip" (click)="removeFilter('minPrice')">
      {{ 'catalog.minPrice' | translate }}: {{ minPrice() }} <span class="chip-close">&times;</span>
    </button>
    }
    @if (maxPrice() != null) {
    <button type="button" class="filter-chip" (click)="removeFilter('maxPrice')">
      {{ 'catalog.maxPrice' | translate }}: {{ maxPrice() }} <span class="chip-close">&times;</span>
    </button>
    }
    @if (color()) {
    <button type="button" class="filter-chip" (click)="removeFilter('color')">
      {{ color() }} <span class="chip-close">&times;</span>
    </button>
    }
    @if (minRating() != null) {
    <button type="button" class="filter-chip" (click)="removeFilter('minRating')">
      {{ 'catalog.minRating' | translate }}: {{ minRating() }}★ <span class="chip-close">&times;</span>
    </button>
    }
    <button type="button" class="filter-chip clear-all" (click)="clearFilters()">
      {{ 'catalog.clearAll' | translate }}
    </button>
  </div>
  }

  <!-- ── Product grid (full width now) ── -->
  <div class="products-wrap">
    @if (loading()) {
    <app-loading-skeleton type="card" [count]="8" />
    } @else if (products().length === 0) {
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
        <circle cx="11" cy="11" r="8" />
        <line x1="21" y1="21" x2="16.65" y2="16.65" />
      </svg>
      <p>{{ 'catalog.noProducts' | translate }}</p>
      @if (activeFilterCount() > 0) {
      <button type="button" class="btn btn-outline" (click)="clearFilters()">{{ 'catalog.clearAll' | translate
        }}</button>
      }
    </div>
    } @else {
    <div class="product-grid">
      @for (p of products(); track p.id || $index) {
      <app-product-card [product]="p" />
      }
    </div>
    @if (totalPages() > 1) {
    <nav class="pagination" aria-label="Pages">
      <button type="button" class="btn btn-outline page-btn" [disabled]="page() <= 1" (click)="goToPage(page() - 1)"
        aria-label="Previous page">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6" />
        </svg>
      </button>
      @for (p of pageNumbers(); track p) {
      <button type="button" class="btn btn-outline page-btn" [class.active]="page() === p" (click)="goToPage(p)">
        {{ p }}
      </button>
      }
      <button type="button" class="btn btn-outline page-btn" [disabled]="page() >= totalPages()"
        (click)="goToPage(page() + 1)" aria-label="Next page">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6" />
        </svg>
      </button>
    </nav>
    }
    }
  </div>
</div>

<!-- ══ Sidebar filter panel ══ -->
@if (filtersOpen()) {
<div class="filter-overlay" (click)="filtersOpen.set(false)"></div>
}

<aside class="filter-sidebar" [class.open]="filtersOpen()" dir="ltr">
  <!-- Sidebar header -->
  <div class="sidebar-header">
    <h2 class="sidebar-title">{{ 'catalog.filters' | translate }}</h2>
    <button type="button" class="sidebar-close" (click)="filtersOpen.set(false)" aria-label="Close filters">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg>
    </button>
  </div>

  <div class="sidebar-body">
    <!-- Search -->
    <div class="sidebar-search">
      <input type="search" [value]="search()" (input)="search.set($any($event.target).value)"
        [placeholder]="'catalog.search' | translate" />
    </div>



    <!-- ── CATEGORY ── -->
    <div class="sidebar-section">
      <button type="button" class="section-toggle" (click)="toggleSection('category')">
        <span class="section-label">{{ 'catalog.category' | translate }}</span>
        <svg class="section-chevron" [class.collapsed]="!sectionOpen['category']" width="14" height="14"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9" />
        </svg>
      </button>
      @if (sectionOpen['category']) {
      <div class="section-content">
        <label class="checkbox-item">
          <input type="radio" name="category" value="" [checked]="!categoryId()"
            (change)="categoryId.set(undefined); applyFilters()" />
          <span class="checkbox-label">{{ 'catalog.all' | translate }}</span>
        </label>
        @for (c of categories(); track c.id) {
        <label class="checkbox-item">
          <input type="radio" name="category" [value]="c.id" [checked]="categoryId() === c.id"
            (change)="categoryId.set($any($event.target).value); applyFilters()" />
          <span class="checkbox-label">{{ getLocalized(c.name) }}</span>
        </label>
        }
      </div>
      }
    </div>

    <!-- ── PRICE ── -->
    <div class="sidebar-section">
      <button type="button" class="section-toggle" (click)="toggleSection('price')">
        <span class="section-label">{{ 'catalog.priceRange' | translate }}</span>
        <svg class="section-chevron" [class.collapsed]="!sectionOpen['price']" width="14" height="14"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9" />
        </svg>
      </button>
      @if (sectionOpen['price']) {
      <div class="section-content">
        <div class="price-range-row">
          <span class="price-label">{{ (minPrice() ?? 0) | priceFormat }}</span>
          <span class="price-label">{{ (maxPrice() ?? 5000) | priceFormat }}</span>
        </div>
        <div class="price-slider-wrap">
          <input type="range" class="price-slider" min="0" max="5000" step="50" [value]="minPrice() ?? 0"
            (input)="minPrice.set(+$any($event.target).value || undefined)" (change)="applyFilters()" />
          <input type="range" class="price-slider" min="0" max="5000" step="50" [value]="maxPrice() ?? 5000"
            (input)="maxPrice.set(+$any($event.target).value === 5000 ? undefined : +$any($event.target).value)"
            (change)="applyFilters()" />
        </div>
      </div>
      }
    </div>

    <!-- ── COLOR ── -->
    <div class="sidebar-section">
      <button type="button" class="section-toggle" (click)="toggleSection('color')">
        <span class="section-label">{{ 'catalog.color' | translate }}</span>
        <svg class="section-chevron" [class.collapsed]="!sectionOpen['color']" width="14" height="14"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9" />
        </svg>
      </button>
      @if (sectionOpen['color']) {
      <div class="section-content">
        <input type="text" class="color-input" [value]="color() ?? ''"
          (input)="color.set($any($event.target).value || undefined)" [placeholder]="'catalog.color' | translate" />
        <button type="button" class="apply-inline-btn" (click)="applyFilters()">{{ 'catalog.apply' | translate
          }}</button>
      </div>
      }
    </div>

    <!-- ── RATING ── -->
    <div class="sidebar-section">
      <button type="button" class="section-toggle" (click)="toggleSection('rating')">
        <span class="section-label">{{ 'catalog.minRating' | translate }}</span>
        <svg class="section-chevron" [class.collapsed]="!sectionOpen['rating']" width="14" height="14"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9" />
        </svg>
      </button>
      @if (sectionOpen['rating']) {
      <div class="section-content">
        @for (r of [1, 2, 3, 4, 5]; track r) {
        <label class="checkbox-item">
          <input type="radio" name="rating" [value]="r" [checked]="minRating() === r"
            (change)="minRating.set(r); applyFilters()" />
          <span class="checkbox-label">
            @for (s of [1,2,3,4,5]; track s) {
            <span class="star" [class.filled]="s <= r">★</span>
            }
            {{ 'catalog.starsAndUp' | translate:{ stars: r } }}
          </span>
        </label>
        }
        @if (minRating() != null) {
        <button type="button" class="clear-section-btn" (click)="minRating.set(undefined); applyFilters()">
          {{ 'catalog.clear' | translate }}
        </button>
        }
      </div>
      }
    </div>
  </div>

  <!-- Sidebar footer -->
  <div class="sidebar-footer">
    <button type="button" class="btn btn-block" (click)="applyFilters()">{{ 'catalog.apply' | translate }}</button>
    @if (activeFilterCount() > 0) {
    <button type="button" class="btn btn-block btn-outline" (click)="clearFilters()">{{ 'catalog.clear' | translate
      }}</button>
    }
  </div>
</aside>